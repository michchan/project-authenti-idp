# System Flow: Task Completion - TaskMaster v1.0

## Trigger
User clicks the checkbox next to a task to mark it as complete.

## Sequence Diagram

```mermaid
sequenceDiagram
    participant User
    participant UI as UI Components
    participant TM as Task Manager
    participant DM as Data Manager
    participant SE as Search Engine
    participant PT as Progress Tracker

    User->>UI: Click task checkbox
    UI->>UI: Show processing feedback
    
    UI->>TM: Request task completion
    TM->>TM: Validate task state
    TM->>TM: Handle subtask requirements
    
    alt Has incomplete subtasks
        TM->>UI: Show confirmation dialog
        UI->>User: Confirm subtask completion
        User->>UI: Confirm completion
        UI->>TM: Proceed with completion
    end
    
    TM->>TM: Update task status
    
    TM->>DM: Persist completion data
    DM->>DM: Store completion
    DM-->>TM: Confirm persistence
    
    TM-->>SE: Task completion event
    SE->>SE: Update search index
    
    TM-->>PT: Task completion event
    PT->>PT: Update statistics
    PT->>PT: Process achievements
    
    TM->>UI: Completion successful
    UI->>UI: Update visual state
    UI->>User: Show completion feedback
    
    opt Achievement detected
        PT->>UI: Achievement notification
        UI->>User: Display achievement
    end
```

## Step-by-Step Timeline

### 1. User Completion Action
**Trigger**: User clicks task checkbox  
**Component**: UI Components (Task List)  
**Actions**:
- Capture task completion request
- Show immediate visual feedback
- Prevent duplicate completion attempts
- Initiate completion workflow

**Success Response**: Visual feedback confirms user action

---

### 2. Task Completion Validation
**Trigger**: Completion request from UI Components  
**Component**: Task Manager  
**Actions**:
- Validate task can be completed
- Check subtask completion status
- Verify system permissions
- Prepare completion data

**Success Response**: Task validated for completion  
**Failure Scenarios**:
- Task not found → Show error and refresh
- Already completed → Sync UI state
- Incomplete subtasks → Show confirmation dialog

---

### 3. Subtask Resolution
**Trigger**: Task with incomplete subtasks requires completion  
**Component**: Task Manager  
**Actions**:
- Handle subtask completion requirements
- Apply completion to related subtasks
- Update subtask progress tracking

**Success Response**: All subtasks properly handled

---

### 4. Task Status Update
**Trigger**: Validated task completion from Task Manager  
**Component**: Task Manager  
**Actions**:
- Update task status to completed
- Record completion timestamp
- Calculate completion metrics
- Prepare status change event

**Success Response**: Task status updated successfully

---

### 5. Data Persistence
**Trigger**: Task status update from Task Manager  
**Component**: Data Manager  
**Actions**:
- Store completion data persistently
- Update related statistics
- Create backup point
- Confirm successful storage

**Success Response**: Task completion persisted  
**Failure Scenarios**:
- Storage limitations → Queue for retry
- Storage errors → Cache changes for retry
- Transaction conflicts → Handle gracefully

---

### 6. Search Index Update
**Trigger**: Task completion event from Task Manager  
**Component**: Search Engine  
**Actions**:
- Update task status in search indexes
- Adjust search result rankings
- Maintain search consistency

**Success Response**: Search reflects task completion

---

### 7. Progress Tracking Update
**Trigger**: Task completion event from Task Manager  
**Component**: Progress Tracker  
**Actions**:
- Update completion statistics
- Recalculate progress metrics
- Check for achievement milestones
- Update trend data

**Success Response**: Progress statistics updated

---

### 8. Achievement Processing
**Trigger**: Progress update from Progress Tracker  
**Component**: Progress Tracker  
**Actions**:
- Evaluate achievement criteria
- Prepare achievement notifications
- Update user progress indicators

**Success Response**: Achievements processed and prepared

---

### 9. UI Visual Updates
**Trigger**: Completion success from Task Manager  
**Component**: UI Components (Task List, Dashboard)  
**Actions**:
- Apply completion visual effects
- Update task positioning in lists
- Update dashboard counters
- Show completion confirmation

**Success Response**: UI reflects task completion

---

### 10. Achievement Notification
**Trigger**: Achievement detection from Progress Tracker  
**Component**: UI Components (Notifications)  
**Actions**:
- Display achievement notifications
- Show milestone celebrations
- Update progress dashboard
- Record achievement history

**Success Response**: User sees achievement feedback  

## Service Roles

### UI Components
- **Primary**: User interaction handling and visual feedback
- **Secondary**: Completion animations and achievement display
- **Data Flow**: Captures user action → Sends to Task Manager → Shows completion results

### Task Manager
- **Primary**: Task completion business logic and workflow coordination
- **Secondary**: Subtask management and validation
- **Data Flow**: Processes completion request → Validates → Updates → Coordinates with other services

### Data Manager  
- **Primary**: Persistent storage of completion data
- **Secondary**: Data consistency and backup management
- **Data Flow**: Receives completion data → Stores persistently → Confirms success

### Search Engine
- **Primary**: Search index updates for completed tasks
- **Secondary**: Search result ranking adjustments
- **Data Flow**: Receives completion event → Updates indexes → Maintains search consistency

### Progress Tracker
- **Primary**: Progress statistics and achievement detection
- **Secondary**: Milestone tracking and user motivation
- **Data Flow**: Receives completion event → Updates metrics → Processes achievements

## Error Scenarios

### Task Completion Conflicts
**Scenario**: Task cannot be completed due to system conflicts  
**Response**:
- Show appropriate error messaging to user
- Maintain task in current state
- Provide retry options
- Handle conflicts gracefully

**Recovery**: User retries completion or system resolves conflicts

---

### Subtask Dependencies
**Scenario**: Task has incomplete subtasks that require completion  
**Response**:
- Show confirmation dialog with subtask status
- Allow user to choose completion strategy
- Handle subtask completion as needed
- Maintain data consistency

**Recovery**: User confirms completion approach and proceeds

---

### Storage Limitations
**Scenario**: Unable to persist task completion due to storage issues  
**Response**:
- Show storage limitation notifications
- Queue completion for later retry
- Maintain local completion state
- Provide cleanup or export options

**Recovery**: User manages storage or system retries automatically

---

### System State Conflicts
**Scenario**: Concurrent modifications create system state conflicts  
**Response**:
- Detect and handle state conflicts gracefully
- Show appropriate user notifications
- Prevent data loss or corruption
- Maintain system consistency

**Recovery**: System resolves conflicts automatically or with user input

---

*This task completion flow ensures reliable task completion while maintaining system integrity and user experience quality.*